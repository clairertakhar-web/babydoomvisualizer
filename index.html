<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>District Enrollment Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Caslon+Text:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #ffffff;
            padding: 20px;
            color: #373737;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            font-family: 'Libre Caslon Text', serif;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #373737;
            text-align: center;
        }
        
        /* Search Container */
        .search-container {
            margin-bottom: 20px;
            max-width: 500px;
            position: relative;
        }
        
        .search-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #373737;
            margin-bottom: 8px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            transition: border-color 0.2s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #19414e;
        }
        
        /* Autocomplete */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #19414e;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        
        .autocomplete-dropdown.show { display: block; }
        
        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .autocomplete-item:hover { background: #f5f5f5; }
        
        .autocomplete-item-name {
            font-weight: 500;
            color: #19414e;
            margin-bottom: 4px;
        }
        
        .autocomplete-item-details {
            font-size: 12px;
            color: #666;
        }
        
        .autocomplete-counter {
            padding: 8px 16px;
            background: #f8f8f8;
            color: #666;
            font-size: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 500;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* Main Content */
        .content-wrapper {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-section {
            flex: 1;
        }
        
        /* Time Range Toggle */
        .time-range-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .time-range-label {
            font-size: 13px;
            font-weight: 500;
            color: #373737;
        }
        
        .time-range-btn {
            padding: 6px 14px;
            border: 2px solid #e0e0e0;
            background: white;
            color: #373737;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-range-btn:hover {
            border-color: #19414e;
        }
        
        .time-range-btn.active {
            background: #19414e;
            color: white;
            border-color: #19414e;
            font-weight: 600;
        }
        
        /* View Toggle */
        .toggle-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .toggle-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            color: #373737;
            font-size: 13px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toggle-btn:hover {
            border-color: #373737;
        }
        
        .toggle-btn.active {
            background: #19414e;
            color: white;
            border-color: #19414e;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            background: #fafafa;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .chart-header {
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-family: 'Libre Caslon Text', serif;
            font-size: 20px;
            font-weight: 600;
            color: #373737;
            margin-bottom: 5px;
        }
        
        .chart-subtitle {
            font-size: 13px;
            color: #666;
        }
        
        .chart-wrapper {
            height: auto;
            position: relative;
        }

        .chart-wrapper.split {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .chart-panel {
            position: relative;
            height: 100%;
        }

        .chart-panel canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .chart-panel-births {
            display: none;
        }

        .chart-wrapper.split .chart-panel {
            flex: 1;
            height: auto;
        }

        .chart-wrapper.split .chart-panel-births {
            display: block;
        }

        .chart-panel-note {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #999;
            background: rgba(250, 250, 250, 0.85);
            text-align: center;
            padding: 10px;
        }

        .chart-panel-note.show {
            display: flex;
        }

        #enrollmentPanel {
            height: 400px;
        }

        #birthsPanel {
            height: 175px;
        }
        
        .export-button {
            position: absolute;
            top: 25px;
            right: 25px;
            padding: 8px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
            color: #373737;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .export-button:hover {
            border-color: #19414e;
            color: #19414e;
        }

        .export-logo {
            height: 48px;
            width: auto;
            object-fit: contain;
        }

        .export-logo.hidden {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }
        
        /* Stats Panel */
        .stats-panel {
            width: 240px;
            background: #fafafa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .stats-panel h2 {
            font-family: 'Libre Caslon Text', serif;
            font-size: 16px;
            font-weight: 600;
            color: #373737;
            margin-bottom: 15px;
        }
        
        .stat-item {
            margin-bottom: 20px;
            padding-bottom: 18px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .stat-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 6px;
        }
        
        .stat-metric {
            font-size: 11px;
            color: #373737;
            font-weight: 600;
        }

        .stat-metric.metric-enrollment {
            color: #19414e;
        }

        .stat-metric.metric-births {
            color: #d4a637;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            line-height: 1;
        }
        
        .stat-births-value {
            font-size: 18px;
            font-weight: 700;
            line-height: 1;
            color: #d4a637;
        }

        .stat-births-value.negative { color: #d9534f; }
        .stat-births-value.positive { color: #5cb85c; }
        .stat-births-value.neutral { color: #999; }
        
        .stat-period {
            font-size: 10px;
            color: #999;
            margin-top: 6px;
        }
        
        .stat-value.negative { color: #d9534f; }
        .stat-value.positive { color: #5cb85c; }
        
        /* Footer */
        footer {
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 10px;
            border-top: 1px solid #e0e0e0;
            margin-top: 20px;
        }
        
        /* Sources Accordion */
        .sources-section {
            max-width: 1200px;
            margin: 30px auto 20px;
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }
        
        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 15px 20px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .accordion-header:hover { background: #f5f5f5; }
        
        .accordion-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Libre Caslon Text', serif;
            font-size: 16px;
            font-weight: 600;
            color: #373737;
        }
        
        .accordion-arrow {
            font-size: 14px;
            color: #666;
            transition: transform 0.3s;
        }
        
        .accordion-arrow.open { transform: rotate(180deg); }
        
        .accordion-content {
            display: none;
            padding: 25px 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        
        .accordion-content.show { display: block; }
        
        .source-section {
            margin-bottom: 25px;
        }
        
        .source-section:last-child { margin-bottom: 0; }
        
        .source-heading {
            font-size: 13px;
            font-weight: 600;
            color: #19414e;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .source-item {
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .source-label {
            font-weight: 500;
            color: #666;
        }
        
        .source-link {
            color: #19414e;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }
        
        .source-link:hover { border-bottom-color: #19414e; }
        
        .source-note {
            font-style: italic;
            color: #666;
            font-size: 13px;
        }
        
        .methodology-list {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .methodology-list li {
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Mobile */
        @media (max-width: 600px) {
            .content-wrapper { 
                flex-direction: column; 
            }
            
            .stats-panel { 
                width: 100%;
                margin-top: 15px;
            }
            
            .chart-wrapper { 
                height: 350px; 
            }
            
            #enrollmentPanel { 
                height: 300px; 
            }
            
            #birthsPanel { 
                height: 150px; 
            }
            
            .export-button {
                position: static;
                display: block;
                margin: 10px auto 15px;
                width: fit-content;
            }
            
            .chart-title {
                font-size: 16px;
            }
            
            .chart-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>District Enrollment Tracker</h1>
        
        <div class="search-container">
            <label class="search-label" for="districtSearch">Search for a school district:</label>
            <input 
                type="text" 
                id="districtSearch" 
                class="search-input" 
                placeholder="Type district name, city, or state..."
                autocomplete="off"
            >
            <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
        </div>
        
        <div id="loadingIndicator" class="loading">
            Loading district data...
        </div>
        
        <div class="content-wrapper" id="contentWrapper" style="display: none;">
            <div class="chart-section">
                <div class="time-range-container">
                    <span class="time-range-label">Time Range:</span>
                    <button class="time-range-btn active" type="button" data-range="all">All (20yr)</button>
                    <button class="time-range-btn" type="button" data-range="10">10 Years</button>
                    <button class="time-range-btn" type="button" data-range="5">5 Years</button>
                </div>
                
                <div class="toggle-buttons">
                    <button class="toggle-btn active" type="button" data-view="district" id="districtBtn">Sample District</button>
                    <button class="toggle-btn" type="button" data-view="state">State Average</button>
                    <button class="toggle-btn" type="button" data-view="us">U.S. Average</button>
                </div>
                
                <div class="chart-container">
                    <button class="export-button" type="button" id="exportButton">üì• Export PNG</button>
                    <img class="export-logo hidden" id="exportLogo" src="logo.png" alt="Planfully Consulting logo" />
                    
                    <div class="chart-header">
                        <div class="chart-title">District Enrollment Trends</div>
                        <div class="chart-subtitle" id="chartSubtitle">Enrollment and births: comparing district, state, and national context</div>
                    </div>
                    
                    <div class="chart-wrapper split" id="chartWrapper">
                        <div class="chart-panel" id="enrollmentPanel">
                            <canvas id="mainChart"></canvas>
                        </div>
                        <div class="chart-panel chart-panel-births" id="birthsPanel">
                            <canvas id="birthsChart"></canvas>
                            <div class="chart-panel-note" id="birthsUnavailable" aria-live="polite">Birth data unavailable</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="stats-panel">
                <h2 id="statsHeader">Change Since 2005</h2>
                <div class="stat-item">
                    <div class="stat-label" id="districtLabel">Sample District</div>
                    <div class="stat-row">
                        <div class="stat-metric metric-enrollment">Enrollment</div>
                        <div class="stat-value negative" id="districtChange">-10.4%</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-metric metric-births">Births</div>
                        <div class="stat-births-value" id="districtBirthsChange">-8.2%</div>
                    </div>
                    <div class="stat-period">2005‚Äì2024</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">State Average</div>
                    <div class="stat-row">
                        <div class="stat-metric metric-enrollment">Enrollment</div>
                        <div class="stat-value negative" id="stateChange">-1.7%</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-metric metric-births">Births</div>
                        <div class="stat-births-value" id="stateBirthsChange">-9.5%</div>
                    </div>
                    <div class="stat-period">2005‚Äì2024</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">U.S. Average</div>
                    <div class="stat-row">
                        <div class="stat-metric metric-enrollment">Enrollment</div>
                        <div class="stat-value positive" id="usChange">+0.6%</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-metric metric-births">Births</div>
                        <div class="stat-births-value" id="usBirthsChange">-4.1%</div>
                    </div>
                    <div class="stat-period">2005‚Äì2024</div>
                </div>
            </div>
        </div>
        
        <div class="sources-section">
            <div class="accordion-header" id="accordionHeader">
                <div class="accordion-title">
                    <span>‚ÑπÔ∏è</span>
                    <span>Sources & Methodology</span>
                </div>
                <span class="accordion-arrow" id="accordionArrow">‚ñº</span>
            </div>
            
            <div class="accordion-content" id="accordionContent">
                <div class="source-section">
                    <div class="source-heading">Enrollment Data</div>
                    <div class="source-item">
                        <span class="source-label">Source:</span> U.S. Department of Education, National Center for Education Statistics (NCES)
                    </div>
                    <div class="source-item">
                        <span class="source-label">Dataset:</span> Common Core of Data (CCD), Local Education Agency Universe Survey
                    </div>
                    <div class="source-item">
                        <span class="source-label">Years:</span> 2005‚Äì2024
                    </div>
                    <div class="source-item">
                        <span class="source-label">Link:</span> <a href="https://nces.ed.gov/ccd/pubagency.asp" target="_blank" rel="noopener" class="source-link">nces.ed.gov/ccd/pubagency.asp</a>
                    </div>
                    <div class="source-item source-note">
                        Note: Total membership includes all grades and all students
                    </div>
                </div>
                
                <div class="source-section">
                    <div class="source-heading">Births Data</div>
                    <div class="source-item">
                        <span class="source-label">Source:</span> Centers for Disease Control and Prevention (CDC), National Center for Health Statistics
                    </div>
                    <div class="source-item">
                        <span class="source-label">Dataset:</span> Natality Public Use Files
                    </div>
                    <div class="source-item">
                        <span class="source-label">Years:</span> 2005‚Äì2023
                    </div>
                    <div class="source-item">
                        <span class="source-label">Geography:</span> County-level aggregated to district approximation
                    </div>
                    <div class="source-item">
                        <span class="source-label">Link:</span> <a href="https://wonder.cdc.gov/natality.html" target="_blank" rel="noopener" class="source-link">wonder.cdc.gov/natality.html</a>
                    </div>
                    <div class="source-item source-note">
                        Note: Birth data used as a proxy for future K-12 enrollment trends
                    </div>
                </div>
                
                <div class="source-section">
                    <div class="source-heading">Methodology</div>
                    <ul class="methodology-list">
                        <li><strong>State averages:</strong> Sum of all district enrollments within each state by year</li>
                        <li><strong>National totals:</strong> Sum of all reporting district enrollments across the United States</li>
                        <li><strong>Birth matching:</strong> County-level birth data matched to districts using primary county designation</li>
                        <li><strong>Percent changes:</strong> Calculated as ((end value - start value) / start value) √ó 100</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <footer>
            Data: NCES, CDC | Updated: 2025
        </footer>
    </div>

    <script>
        // Global state
        let districtsData = [];
        let enrollmentData = {};
        let stateAggregates = {};
        let nationalAggregates = {};
        let birthsData = {};
        let stateBirthsAggregates = {};
        let nationalBirthsAggregates = {};
        
        let mainChart;
        let birthsChart;
        let chartMode = 'split';
        let selectedDistrict = null;
        let currentTimeRange = 'all';
        let currentView = 'district';

        let currentEnrollmentSeries = { years: [], values: [], label: '' };
        let currentBirthSeries = { years: [], values: [], label: '' };
        const BASE_URL = new URL('.', window.location.href);
        function withBase(path) {
            return new URL(path.replace(/^\/+/, ''), BASE_URL).toString();
        }
        const LOGO_DATA_URI = 'data:image/png;base64,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';
        const LOGO_SRC = LOGO_DATA_URI;
        
        const dom = {
            searchInput: null,
            dropdown: null,
            loadingIndicator: null,
            contentWrapper: null,
            chartSubtitle: null,
            statsHeader: null,
            districtBtn: null,
            exportButton: null,
            chartWrapper: null,
            birthsPanel: null,
            birthsCanvas: null,
            birthsUnavailable: null,
            accordionHeader: null,
            accordionContent: null,
            accordionArrow: null,
            statPeriods: []
        };
        
        // Color hierarchy - teal for enrollment, darker gold for births
        const COLORS = {
            districtEnroll: '#19414e',   // Deep teal
            stateEnroll: '#5a8a99',      // Medium teal
            usEnroll: '#8db3bf',         // Light teal
            births: '#d4a637'            // Darker gold/yellow
        };
        
        function getEl(id) {
            return document.getElementById(id);
        }

        function getTooltipCallbacks() {
            return {
                title: (items) => `Year ${items[0].label}`,
                label: (context) => {
                    const label = context.dataset.label || '';
                    const value = context.parsed.y;
                    if (!Number.isFinite(value)) {
                        return null;
                    }
                    return `${label}: ${value.toLocaleString()}`;
                }
            };
        }

        function getTooltipOptions() {
            return {
                backgroundColor: '#2c3e50',
                titleColor: '#ecf0f1',
                bodyColor: '#ecf0f1',
                padding: 12,
                displayColors: false,
                titleFont: { size: 11, weight: '600' },
                bodyFont: { size: 12 },
                callbacks: getTooltipCallbacks()
            };
        }

        function createDualChart(labels, enrollmentValues, enrollmentLabel, birthsValues, birthsLabel) {
            const canvas = getEl('mainChart');
            if (!canvas || !window.Chart) {
                return null;
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                return null;
            }

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: enrollmentLabel,
                            data: enrollmentValues,
                            borderColor: COLORS.districtEnroll,
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.1,
                            pointRadius: 3,
                            yAxisID: 'y',
                            hidden: false
                        },
                        {
                            label: 'State Average',
                            data: [],
                            borderColor: COLORS.stateEnroll,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 2,
                            yAxisID: 'y',
                            hidden: true
                        },
                        {
                            label: 'U.S. Average',
                            data: [],
                            borderColor: COLORS.usEnroll,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 2,
                            yAxisID: 'y',
                            hidden: true
                        },
                        {
                            label: birthsLabel,
                            data: birthsValues,
                            borderColor: COLORS.births,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 3],
                            tension: 0.1,
                            pointRadius: 2,
                            yAxisID: 'y2',
                            hidden: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 },
                                color: '#666',
                                filter: function(item, chart) {
                                    return !chart.datasets[item.datasetIndex].hidden;
                                }
                            }
                        },
                        tooltip: getTooltipOptions()
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#999', font: { size: 11 } },
                            title: {
                                display: true,
                                text: 'School Year',
                                color: '#666',
                                font: { size: 11, weight: '500' }
                            }
                        },
                        y: {
                            position: 'left',
                            beginAtZero: false,
                            grid: { color: '#f0f0f0', drawBorder: false },
                            ticks: {
                                color: COLORS.districtEnroll,
                                font: { size: 11 },
                                callback: (value) => value.toLocaleString()
                            },
                            title: {
                                display: true,
                                text: 'Total Enrollment',
                                color: COLORS.districtEnroll,
                                font: { size: 11, weight: '600' }
                            },
                            grace: '5%'
                        },
                        y2: {
                            position: 'right',
                            beginAtZero: false,
                            grid: { display: false },
                            ticks: {
                                color: COLORS.births,
                                font: { size: 11 },
                                callback: (value) => value.toLocaleString()
                            },
                            title: {
                                display: true,
                                text: 'Births per Year',
                                color: COLORS.births,
                                font: { size: 11, weight: '600' }
                            },
                            grace: '5%'
                        }
                    }
                }
            });
        }

        function createEnrollmentChart(labels, values, label) {
            const canvas = getEl('mainChart');
            if (!canvas || !window.Chart) {
                return null;
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                return null;
            }

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label,
                            data: values,
                            borderColor: COLORS.districtEnroll,
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.1,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 },
                                color: '#666'
                            }
                        },
                        tooltip: getTooltipOptions()
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#999', font: { size: 11 } },
                            title: {
                                display: true,
                                text: 'School Year',
                                color: '#666',
                                font: { size: 11, weight: '500' }
                            }
                        },
                        y: {
                            position: 'left',
                            beginAtZero: false,
                            grid: { color: '#f0f0f0', drawBorder: false },
                            ticks: {
                                color: COLORS.districtEnroll,
                                font: { size: 11 },
                                callback: (value) => value.toLocaleString()
                            },
                            title: {
                                display: true,
                                text: 'Total Enrollment',
                                color: COLORS.districtEnroll,
                                font: { size: 11, weight: '600' }
                            },
                            grace: '5%'
                        }
                    }
                }
            });
        }

        function createBirthsChart(labels, values, label) {
            const canvas = getEl('birthsChart');
            if (!canvas || !window.Chart) {
                return null;
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                return null;
            }

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label,
                            data: values,
                            borderColor: COLORS.births,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 3],
                            tension: 0.1,
                            pointRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 },
                                color: '#666'
                            }
                        },
                        tooltip: getTooltipOptions()
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#999', font: { size: 11 } },
                            title: {
                                display: true,
                                text: 'School Year',
                                color: '#666',
                                font: { size: 11, weight: '500' }
                            }
                        },
                        y: {
                            position: 'left',
                            beginAtZero: false,
                            grid: { color: '#f0f0f0', drawBorder: false },
                            ticks: {
                                color: COLORS.births,
                                font: { size: 11 },
                                callback: (value) => value.toLocaleString()
                            },
                            title: {
                                display: true,
                                text: 'Births per Year',
                                color: COLORS.births,
                                font: { size: 11, weight: '600' }
                            },
                            grace: '5%'
                        }
                    }
                }
            });
        }
        
        // Load data
        async function fetchJson(path) {
            const url = withBase(path);
            const response = await fetch(url);
            if (!response.ok) {
                let body = '';
                try {
                    body = await response.text();
                } catch (err) {
                    body = '';
                }
                console.error('Fetch failed', {
                    url,
                    status: response.status,
                    statusText: response.statusText,
                    body: body.slice(0, 300)
                });
                throw new Error(`Fetch failed: ${response.status}`);
            }
            return response.json();
        }

        async function loadData() {
            try {
                const [districts, enrollment, stateAgg, nationalAgg, births, stateBirths, nationalBirths] = await Promise.all([
                    fetchJson('districts.json'),
                    fetchJson('enrollment_data.json'),
                    fetchJson('state_aggregates.json'),
                    fetchJson('national_aggregates.json'),
                    fetchJson('births_data.json'),
                    fetchJson('state_births_aggregates.json'),
                    fetchJson('national_births_aggregates.json')
                ]);
                
                districtsData = districts;
                enrollmentData = enrollment;
                stateAggregates = stateAgg;
                nationalAggregates = nationalAgg;
                birthsData = births;
                stateBirthsAggregates = stateBirths;
                nationalBirthsAggregates = nationalBirths;
                
                console.log(`‚úì Loaded ${districtsData.length} districts`);
                
                // FIX 1: Auto-load Los Angeles Unified - try multiple methods
                let lausd = districtsData.find(d => d.leaid === '0622710.0');
                
                // Fallback 1: Try without .0
                if (!lausd) {
                    lausd = districtsData.find(d => d.leaid === '0622710');
                }
                
                // Fallback 2: Try with different formatting
                if (!lausd) {
                    lausd = districtsData.find(d => d.leaid && d.leaid.startsWith('062271'));
                }
                
                // Fallback 3: Search by name
                if (!lausd) {
                    lausd = districtsData.find(d => 
                        d.name && 
                        d.state === 'California' && 
                        d.name.toUpperCase().includes('LOS ANGELES UNIFIED')
                    );
                }
                
                // Fallback 4: Any Los Angeles Unified
                if (!lausd) {
                    lausd = districtsData.find(d => 
                        d.name && 
                        d.name.toUpperCase().includes('LOS ANGELES') && 
                        d.name.toUpperCase().includes('UNIFIED')
                    );
                }
                
                if (lausd) {
                    console.log('‚úì Auto-loading:', lausd.name, '(LEAID:', lausd.leaid + ')');
                    selectedDistrict = lausd;
                    
                    // Update button text
                    if (dom.districtBtn) {
                        dom.districtBtn.textContent = 'L.A. Unified';
                    }
                    
                    // Load LAUSD data (creates charts for first time)
                    loadDistrictData(lausd);
                    
                    // Show content after data loads
                    if (dom.loadingIndicator) {
                        dom.loadingIndicator.style.display = 'none';
                    }
                    if (dom.contentWrapper) {
                        dom.contentWrapper.style.display = 'flex';
                    }
                } else {
                    console.error('‚ö†Ô∏è Could not find Los Angeles Unified');
                    console.log('First 5 California districts:', 
                        districtsData.filter(d => d.state === 'California').slice(0, 5).map(d => ({
                            name: d.name,
                            leaid: d.leaid
                        }))
                    );
                    if (dom.loadingIndicator) {
                        dom.loadingIndicator.innerHTML = '‚ö†Ô∏è LAUSD not found. Check console for available districts.';
                    }
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                if (dom.loadingIndicator) {
                    dom.loadingIndicator.innerHTML =
                        '‚ö†Ô∏è Error loading data. Please refresh.<br><span style="font-size:12px;color:#999;">Details in console</span>';
                }
            }
        }
        
        

        function setActiveButton(selector, target) {
            document.querySelectorAll(selector).forEach(btn => btn.classList.remove('active'));
            if (target) {
                target.classList.add('active');
            }
        }
        
        // Time range filtering
        function setTimeRange(range, target) {
            currentTimeRange = range === 'all' ? 'all' : String(range);
            setActiveButton('.time-range-btn', target);
            
            const numericRange = range === 'all' ? null : Number(range);
            let startYear = 2005;
            if (numericRange === 10) {
                startYear = 2015;
            } else if (numericRange === 5) {
                startYear = 2020;
            }
            if (dom.statsHeader) {
                dom.statsHeader.textContent = `Change Since ${startYear}`;
            }
            
            if (selectedDistrict) {
                loadDistrictData(selectedDistrict);
            }
        }
        
        function filterDataByTimeRange(years, data) {
            if (currentTimeRange === 'all') {
                return { years, data };
            }
            
            const numYears = parseInt(currentTimeRange, 10);
            const startIndex = Math.max(0, years.length - numYears);
            
            return {
                years: years.slice(startIndex),
                data: data.slice(startIndex)
            };
        }

        function buildDistrictEnrollmentSeries(districtData) {
            if (!districtData || !Array.isArray(districtData.years) || !Array.isArray(districtData.enrollment)) {
                return { years: [], values: [] };
            }
            return { years: districtData.years, values: districtData.enrollment };
        }

        function aggregateEnrollmentFromDistricts(matchFn) {
            const totalsByYear = {};
            districtsData.forEach(district => {
                if (!matchFn(district)) {
                    return;
                }
                const data = enrollmentData[district.leaid];
                if (!data || !Array.isArray(data.years) || !Array.isArray(data.enrollment)) {
                    return;
                }
                data.years.forEach((year, idx) => {
                    const value = data.enrollment[idx];
                    if (typeof value !== 'number') {
                        return;
                    }
                    totalsByYear[year] = (totalsByYear[year] || 0) + value;
                });
            });

            const years = Object.keys(totalsByYear).map(Number).sort((a, b) => a - b);
            const values = years.map(year => totalsByYear[year]);
            return { years, values };
        }

        function buildStateAggregateEnrollmentSeries(stateCode) {
            const stateData = stateAggregates[stateCode];
            if (stateData && Array.isArray(stateData.years) && Array.isArray(stateData.enrollment)) {
                return { years: stateData.years, values: stateData.enrollment };
            }
            return aggregateEnrollmentFromDistricts(district => district.state === stateCode);
        }

        function buildUSAggregateEnrollmentSeries() {
            if (nationalAggregates && Array.isArray(nationalAggregates.years) && Array.isArray(nationalAggregates.enrollment)) {
                return { years: nationalAggregates.years, values: nationalAggregates.enrollment };
            }
            return aggregateEnrollmentFromDistricts(() => true);
        }

        function buildBirthSeries(birthsSeries) {
            if (!birthsSeries || !Array.isArray(birthsSeries.years) || !Array.isArray(birthsSeries.births)) {
                return { years: [], values: [] };
            }
            return { years: birthsSeries.years, values: birthsSeries.births };
        }

        function setEnrollmentSeries(series, label) {
            const filtered = filterDataByTimeRange(series.years || [], series.values || []);
            currentEnrollmentSeries = { years: filtered.years, values: filtered.data, label };
        }

        function setBirthSeries(series, label) {
            const filtered = filterDataByTimeRange(series.years || [], series.values || []);
            currentBirthSeries = { years: filtered.years, values: filtered.data, label };
        }

        function computeMagnitudeRatio(enrollmentValues, birthValues) {
            const enrollMax = Math.max(...enrollmentValues.filter(Number.isFinite));
            const birthMax = Math.max(...birthValues.filter(Number.isFinite));
            if (!Number.isFinite(enrollMax) || !Number.isFinite(birthMax) || birthMax === 0) {
                return null;
            }
            return enrollMax / birthMax;
        }

        function haveAlignedYears() {
            if (currentEnrollmentSeries.years.length !== currentBirthSeries.years.length) {
                return false;
            }
            return currentEnrollmentSeries.years.every((year, idx) => year === currentBirthSeries.years[idx]);
        }

        function updateSubtitle(hasBirths) {
            const subtitles = {
                district: 'Enrollment and births: comparing district, state, and national context',
                state: 'State-level enrollment and births trends',
                us: 'National enrollment and births trends'
            };
            const base = subtitles[currentView] || '';
            if (dom.chartSubtitle) {
                dom.chartSubtitle.textContent = hasBirths ? base : `${base} ‚Ä¢ Birth data unavailable`;
            }
        }

        function buildAlignedYears() {
            const yearSet = new Set();
            currentEnrollmentSeries.years.forEach(year => yearSet.add(year));
            currentBirthSeries.years.forEach(year => yearSet.add(year));
            return Array.from(yearSet).sort((a, b) => Number(a) - Number(b));
        }

        function mapSeriesByYear(years, seriesYears, seriesValues) {
            const map = {};
            seriesYears.forEach((year, idx) => {
                map[String(year)] = seriesValues[idx];
            });
            return years.map(year => {
                const value = map[String(year)];
                return Number.isFinite(value) ? value : null;
            });
        }

        function refreshChartRendering() {
            const hasBirths = currentBirthSeries.values.some(Number.isFinite);
            updateSubtitle(hasBirths);

            if (dom.birthsUnavailable) {
                dom.birthsUnavailable.classList.toggle('show', !hasBirths);
            }

            if (!mainChart || !birthsChart) {
                return;
            }

            const alignedYears = buildAlignedYears();
            const labels = alignedYears.map(year => year.toString());
            const enrollmentValues = mapSeriesByYear(alignedYears, currentEnrollmentSeries.years, currentEnrollmentSeries.values);
            const birthsValues = mapSeriesByYear(alignedYears, currentBirthSeries.years, currentBirthSeries.values);

            mainChart.data.labels = labels;
            mainChart.data.datasets[0].data = enrollmentValues;
            mainChart.data.datasets[0].label = currentEnrollmentSeries.label || 'District Enrollment';
            if (mainChart.options.plugins && mainChart.options.plugins.tooltip) {
                mainChart.options.plugins.tooltip.callbacks = getTooltipCallbacks();
            }
            mainChart.update();

            birthsChart.data.labels = labels;
            birthsChart.data.datasets[0].data = birthsValues;
            birthsChart.data.datasets[0].label = currentBirthSeries.label || 'Births';
            if (birthsChart.options.plugins && birthsChart.options.plugins.tooltip) {
                birthsChart.options.plugins.tooltip.callbacks = getTooltipCallbacks();
            }
            birthsChart.update();
        }
        
        // View toggle
        function toggleView(view, target) {
            setActiveButton('.toggle-btn', target);
            
            currentView = view;
            
            if (!selectedDistrict || !mainChart) {
                return;
            }
            
            // Instead of hiding/showing datasets, update their data for smooth transitions
            // This makes enrollment lines transition smoothly like births does
            
            if (view === 'district') {
                // District enrollment: show data
                const districtData = enrollmentData[selectedDistrict.leaid];
                const districtSeries = buildDistrictEnrollmentSeries(districtData);
                setEnrollmentSeries(districtSeries, selectedDistrict.name);
                
                // State/US: empty data (causes smooth fade out)
                
                // District births
                const districtBirths = birthsData[selectedDistrict.leaid];
                if (districtBirths) {
                    const birthsSeries = buildBirthSeries(districtBirths);
                    setBirthSeries(birthsSeries, `Births (${districtBirths.county})`);
                } else {
                    setBirthSeries({ years: [], values: [] }, 'Births');
                }
                
            } else if (view === 'state') {
                // State enrollment: show data
                const stateSeries = buildStateAggregateEnrollmentSeries(selectedDistrict.state);
                setEnrollmentSeries(stateSeries, 'State Average');
                
                // District/US: empty data
                
                // State births
                if (stateBirthsAggregates[selectedDistrict.state]) {
                    const stateBirths = stateBirthsAggregates[selectedDistrict.state];
                    const birthsSeries = buildBirthSeries(stateBirths);
                    setBirthSeries(birthsSeries, `Births (${selectedDistrict.state})`);
                } else {
                    setBirthSeries({ years: [], values: [] }, 'Births');
                }
                
            } else if (view === 'us') {
                // US enrollment: show data
                const usSeries = buildUSAggregateEnrollmentSeries();
                setEnrollmentSeries(usSeries, 'U.S. Average');
                
                // District/State: empty data
                
                // US births
                const birthsSeries = buildBirthSeries(nationalBirthsAggregates);
                setBirthSeries(birthsSeries, 'Births (U.S.)');
            }

            refreshChartRendering();
        }
        
        // Search functionality
        function handleSearchInput(e) {
            if (!dom.dropdown) {
                return;
            }
            const searchTerm = e.target.value.trim();
            
            if (searchTerm.length < 2) {
                dom.dropdown.classList.remove('show');
                return;
            }
            
            const words = searchTerm.toLowerCase().split(/\s+/);
            
            const matches = districtsData.filter(d => {
                const text = `${d.name} ${d.state} ${d.county || ''}`.toLowerCase();
                return words.every(word => text.includes(word));
            }).slice(0, 50);
            
            displayAutocomplete(matches);
        }
        
        function displayAutocomplete(matches) {
            if (!dom.dropdown) {
                return;
            }
            dom.dropdown.innerHTML = '';
            
            if (matches.length === 0) {
                dom.dropdown.innerHTML = '<div style="padding:12px 16px;color:#999;">No districts found</div>';
                dom.dropdown.classList.add('show');
                return;
            }
            
            const counter = document.createElement('div');
            counter.className = 'autocomplete-counter';
            counter.textContent = matches.length === 50 ? 
                `Showing 50 results` : 
                `${matches.length} ${matches.length === 1 ? 'district' : 'districts'} found`;
            dom.dropdown.appendChild(counter);
            
            matches.forEach(district => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `
                    <div class="autocomplete-item-name">${district.name}</div>
                    <div class="autocomplete-item-details">${district.state}${district.county ? ' - ' + district.county : ''}</div>
                `;
                item.addEventListener('click', () => selectDistrict(district));
                dom.dropdown.appendChild(item);
            });
            
            dom.dropdown.classList.add('show');
        }
        
        function selectDistrict(district) {
            selectedDistrict = district;
            if (dom.searchInput) {
                dom.searchInput.value = `${district.name} (${district.state})`;
            }
            if (dom.dropdown) {
                dom.dropdown.classList.remove('show');
            }
            
            loadDistrictData(district);
        }
        
        function handleDocumentClick(e) {
            if (!dom.searchInput || !dom.dropdown) {
                return;
            }
            if (!dom.searchInput.contains(e.target) && !dom.dropdown.contains(e.target)) {
                dom.dropdown.classList.remove('show');
            }
        }
        
        // Load district data
        function loadDistrictData(district) {
            const districtData = enrollmentData[district.leaid];
            
            if (!districtData) {
                alert('No enrollment data available for this district');
                return;
            }
            
            // Create charts if they don't exist yet
            if (!mainChart || !birthsChart) {
                // Get district enrollment series
                const districtSeries = buildDistrictEnrollmentSeries(districtData);
                const filtered = filterDataByTimeRange(districtSeries.years, districtSeries.values);
                
                // Get district births series
                const districtBirths = birthsData[district.leaid];
                let birthsFiltered = { years: [], data: [] };
                if (districtBirths) {
                    const birthsSeries = buildBirthSeries(districtBirths);
                    birthsFiltered = filterDataByTimeRange(birthsSeries.years, birthsSeries.values);
                }
                
                // Create charts with real data
                mainChart = createEnrollmentChart(filtered.years.map(String), filtered.data, district.name);
                birthsChart = createBirthsChart(
                    birthsFiltered.years.map(String), 
                    birthsFiltered.data, 
                    districtBirths ? `Births (${districtBirths.county})` : 'Births'
                );
                chartMode = 'split';
            }
            
            if (currentView === 'state') {
                const stateSeries = buildStateAggregateEnrollmentSeries(district.state);
                setEnrollmentSeries(stateSeries, 'State Average');
            } else if (currentView === 'us') {
                const usSeries = buildUSAggregateEnrollmentSeries();
                setEnrollmentSeries(usSeries, 'U.S. Average');
            } else {
                const districtSeries = buildDistrictEnrollmentSeries(districtData);
                setEnrollmentSeries(districtSeries, district.name);
            }
            
            // Update births
            const districtBirths = birthsData[district.leaid];
            if (districtBirths) {
                const birthsSeries = buildBirthSeries(districtBirths);
                setBirthSeries(birthsSeries, `Births (${districtBirths.county})`);
            } else {
                setBirthSeries({ years: [], values: [] }, 'Births');
            }
            
            refreshChartRendering();
            
            // Update button
            if (dom.districtBtn) {
                dom.districtBtn.textContent = 
                    district.name.length > 25 ? district.name.substring(0, 22) + '...' : district.name;
            }
            
            // Update stats
            updateStatsPanel(district, districtData);
        }
        
        function updateStatsPanel(district, districtData) {
            const filtered = filterDataByTimeRange(districtData.years || [], districtData.enrollment || []);
            const years = filtered.years;
            const enrollment = filtered.data;
            
            if (years.length > 1 && enrollment.length > 1 && enrollment[0] !== 0) {
                const percentChange = ((enrollment[enrollment.length - 1] - enrollment[0]) / enrollment[0]) * 100;
                const districtChange = getEl('districtChange');
                if (districtChange) {
                    districtChange.textContent = (percentChange >= 0 ? '+' : '') + percentChange.toFixed(1) + '%';
                    districtChange.className = 'stat-value ' + (percentChange < 0 ? 'negative' : 'positive');
                }
            }
            
            const districtLabel = getEl('districtLabel');
            if (districtLabel) {
                districtLabel.textContent = district.name.length > 22 ? district.name.substring(0, 19) + '...' : district.name;
            }
            
            if (dom.statPeriods[0] && years.length > 1) {
                dom.statPeriods[0].textContent = `${years[0]}‚Äì${years[years.length - 1]}`;
            }
            
            // Calculate district birth change
            const districtBirths = birthsData[district.leaid];
            const districtBirthsChange = getEl('districtBirthsChange');
            if (districtBirths && districtBirthsChange) {
                const birthsFiltered = filterDataByTimeRange(districtBirths.years, districtBirths.births);
                if (birthsFiltered.data.length > 1 && birthsFiltered.data[0] !== 0) {
                    const birthChange = ((birthsFiltered.data[birthsFiltered.data.length - 1] - birthsFiltered.data[0]) / birthsFiltered.data[0]) * 100;
                    districtBirthsChange.textContent = `${(birthChange >= 0 ? '+' : '')}${birthChange.toFixed(1)}%`;
                    districtBirthsChange.className =
                        'stat-births-value ' + (birthChange > 0 ? 'positive' : birthChange < 0 ? 'negative' : 'neutral');
                } else {
                    districtBirthsChange.textContent = 'No data';
                    districtBirthsChange.className = 'stat-births-value neutral';
                }
            } else if (districtBirthsChange) {
                districtBirthsChange.textContent = 'No data';
                districtBirthsChange.className = 'stat-births-value neutral';
            }
            
            // Update state stats
            if (stateAggregates[district.state]) {
                const stateFiltered = filterDataByTimeRange(
                    stateAggregates[district.state].years,
                    stateAggregates[district.state].enrollment
                );
                if (stateFiltered.data.length > 1 && stateFiltered.data[0] !== 0) {
                    const stateChange = ((stateFiltered.data[stateFiltered.data.length - 1] - stateFiltered.data[0]) / stateFiltered.data[0]) * 100;
                    const stateChangeEl = getEl('stateChange');
                    if (stateChangeEl) {
                        stateChangeEl.textContent = (stateChange >= 0 ? '+' : '') + stateChange.toFixed(1) + '%';
                        stateChangeEl.className = 'stat-value ' + (stateChange < 0 ? 'negative' : 'positive');
                    }
                }
                
                if (dom.statPeriods[1]) {
                    dom.statPeriods[1].textContent = 
                        `${stateFiltered.years[0]}‚Äì${stateFiltered.years[stateFiltered.years.length - 1]}`;
                }
                
                // Calculate state birth change
                const stateBirthsChange = getEl('stateBirthsChange');
                if (stateBirthsAggregates[district.state] && stateBirthsChange) {
                    const stateBirths = stateBirthsAggregates[district.state];
                    const stateBirthsFiltered = filterDataByTimeRange(stateBirths.years, stateBirths.births);
                    if (stateBirthsFiltered.data.length > 1 && stateBirthsFiltered.data[0] !== 0) {
                        const stateBirthChange = ((stateBirthsFiltered.data[stateBirthsFiltered.data.length - 1] - stateBirthsFiltered.data[0]) / stateBirthsFiltered.data[0]) * 100;
                        stateBirthsChange.textContent = 
                            `${(stateBirthChange >= 0 ? '+' : '')}${stateBirthChange.toFixed(1)}%`;
                        stateBirthsChange.className =
                            'stat-births-value ' + (stateBirthChange > 0 ? 'positive' : stateBirthChange < 0 ? 'negative' : 'neutral');
                    } else {
                        stateBirthsChange.textContent = 'No data';
                        stateBirthsChange.className = 'stat-births-value neutral';
                    }
                } else if (stateBirthsChange) {
                    stateBirthsChange.textContent = 'No data';
                    stateBirthsChange.className = 'stat-births-value neutral';
                }
            }
            
            // Update U.S. stats
            const usFiltered = filterDataByTimeRange(nationalAggregates.years || [], nationalAggregates.enrollment || []);
            if (usFiltered.data.length > 1 && usFiltered.data[0] !== 0) {
                const usChange = ((usFiltered.data[usFiltered.data.length - 1] - usFiltered.data[0]) / usFiltered.data[0]) * 100;
                const usChangeEl = getEl('usChange');
                if (usChangeEl) {
                    usChangeEl.textContent = (usChange >= 0 ? '+' : '') + usChange.toFixed(1) + '%';
                    usChangeEl.className = 'stat-value ' + (usChange < 0 ? 'negative' : 'positive');
                }
            }
            
            if (dom.statPeriods[2] && usFiltered.years.length > 1) {
                dom.statPeriods[2].textContent = 
                    `${usFiltered.years[0]}‚Äì${usFiltered.years[usFiltered.years.length - 1]}`;
            }
            
            // Calculate U.S. birth change
            const usBirthsFiltered = filterDataByTimeRange(nationalBirthsAggregates.years || [], nationalBirthsAggregates.births || []);
            const usBirthsChange = getEl('usBirthsChange');
            if (usBirthsChange) {
                if (usBirthsFiltered.data.length > 1 && usBirthsFiltered.data[0] !== 0) {
                    const usBirthChange = ((usBirthsFiltered.data[usBirthsFiltered.data.length - 1] - usBirthsFiltered.data[0]) / usBirthsFiltered.data[0]) * 100;
                    usBirthsChange.textContent = 
                        `${(usBirthChange >= 0 ? '+' : '')}${usBirthChange.toFixed(1)}%`;
                    usBirthsChange.className =
                        'stat-births-value ' + (usBirthChange > 0 ? 'positive' : usBirthChange < 0 ? 'negative' : 'neutral');
                } else {
                    usBirthsChange.textContent = 'No data';
                    usBirthsChange.className = 'stat-births-value neutral';
                }
            }
        }
        
        async function loadImageFromDataUri(dataUri) {
            if (!dataUri) {
                return null;
            }

            const img = new Image();
            const waitForLoad = () => new Promise((resolve, reject) => {
                if (img.complete && img.naturalWidth > 0) {
                    resolve();
                    return;
                }
                img.onload = () => resolve();
                img.onerror = () => reject(new Error('Image load failed'));
            });

            img.src = dataUri;
            if (typeof img.decode === 'function') {
                try {
                    await img.decode();
                } catch (err) {
                    await waitForLoad();
                }
            } else {
                await waitForLoad();
            }

            return img;
        }

        // Export to PNG - Professional Board-Ready Format
        async function exportToPNG() {
            const enrollmentCanvas = getEl('mainChart');
            const birthsCanvas = getEl('birthsChart');
            if (!enrollmentCanvas || !birthsCanvas) {
                return;
            }

            // Get district information for prominent display
            const districtName = selectedDistrict ? selectedDistrict.name : 'District';
            const districtState = selectedDistrict ? selectedDistrict.state : '';
            const districtCounty = selectedDistrict ? (selectedDistrict.county || '') : '';
            
            // Professional layout constants
            const padding = 40;
            const headerHeight = 140;
            const chartsGap = 20;
            const statsHeight = 240;
            const footerHeight = 80;
            const sectionGap = 30;

            const width = Math.max(enrollmentCanvas.width, birthsCanvas.width);
            const chartsHeight = enrollmentCanvas.height + birthsCanvas.height + chartsGap;
            const height = headerHeight + chartsHeight + statsHeight + footerHeight + sectionGap * 2;

            const combined = document.createElement('canvas');
            combined.width = width;
            combined.height = height;
            const ctx = combined.getContext('2d');
            if (!ctx) {
                return;
            }

            // Professional white background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);

            // ============ HEADER SECTION - Professional Hierarchy ============
            
            // Main report title - Large, bold, professional
            ctx.fillStyle = '#1a1a1a';
            ctx.font = "700 32px 'Libre Caslon Text', serif";
            ctx.fillText('Enrollment Trends Report', padding, padding + 35);
            
            // District name - Prominent, easy to identify
            ctx.fillStyle = '#19414e';
            ctx.font = "600 24px 'Libre Caslon Text', serif";
            const districtText = districtName.length > 45 ? districtName.substring(0, 42) + '...' : districtName;
            ctx.fillText(districtText, padding, padding + 70);
            
            // Location info - Lighter, supporting detail
            if (districtState || districtCounty) {
                ctx.fillStyle = '#666';
                ctx.font = "400 15px 'Helvetica Neue', Helvetica, Arial, sans-serif";
                const locationText = districtCounty ? `${districtCounty}, ${districtState}` : districtState;
                ctx.fillText(locationText, padding, padding + 95);
            }

            // Subtle divider line
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, headerHeight - 10);
            ctx.lineTo(width - padding, headerHeight - 10);
            ctx.stroke();

            // ============ CHARTS SECTION ============
            const chartsTop = headerHeight + sectionGap;
            ctx.drawImage(enrollmentCanvas, 0, chartsTop);
            ctx.drawImage(birthsCanvas, 0, chartsTop + enrollmentCanvas.height + chartsGap);

            // ============ KEY FINDINGS SECTION ============
            const statsTop = chartsTop + chartsHeight + sectionGap;
            
            // Section header - Professional styling
            ctx.fillStyle = '#1a1a1a';
            ctx.font = "600 18px 'Libre Caslon Text', serif";
            ctx.fillText('Key Findings', padding, statsTop + 25);
            
            // Light background for stats
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(padding, statsTop + 35, width - padding * 2, statsHeight - 45);
            
            // Stats border
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.strokeRect(padding, statsTop + 35, width - padding * 2, statsHeight - 45);

            // Get time period for context
            const timePeriod = document.querySelectorAll('.stat-period')[0]?.textContent || '2005‚Äì2024';

            const statRows = [
                {
                    label: districtName.length > 35 ? districtName.substring(0, 32) + '...' : districtName,
                    enrollment: document.getElementById('districtChange')?.textContent || '',
                    births: document.getElementById('districtBirthsChange')?.textContent || '',
                    period: timePeriod,
                    isPrimary: true
                },
                {
                    label: `${districtState} Average`,
                    enrollment: document.getElementById('stateChange')?.textContent || '',
                    births: document.getElementById('stateBirthsChange')?.textContent || '',
                    period: timePeriod,
                    isPrimary: false
                },
                {
                    label: 'U.S. Average',
                    enrollment: document.getElementById('usChange')?.textContent || '',
                    births: document.getElementById('usBirthsChange')?.textContent || '',
                    period: timePeriod,
                    isPrimary: false
                }
            ];

            let rowY = statsTop + 65;
            const rowHeight = 55;

            statRows.forEach((row, index) => {
                // Row label - Bold for district, regular for comparisons
                ctx.fillStyle = row.isPrimary ? '#1a1a1a' : '#4a4a4a';
                ctx.font = row.isPrimary ? 
                    "600 14px 'Helvetica Neue', Helvetica, Arial, sans-serif" : 
                    "500 13px 'Helvetica Neue', Helvetica, Arial, sans-serif";
                ctx.fillText(row.label, padding + 20, rowY);

                // Enrollment change - Professional presentation
                const enrollX = padding + 320;
                ctx.fillStyle = '#5a5a5a';
                ctx.font = "500 12px 'Helvetica Neue', Helvetica, Arial, sans-serif";
                ctx.fillText('Enrollment', enrollX, rowY);
                
                // Enrollment value - Color-coded, prominent
                const enrollValue = row.enrollment;
                ctx.fillStyle = enrollValue.startsWith('-') ? '#c53030' : enrollValue.startsWith('+') ? '#2f855a' : '#5a5a5a';
                ctx.font = row.isPrimary ? 
                    "700 20px 'Helvetica Neue', Helvetica, Arial, sans-serif" : 
                    "600 16px 'Helvetica Neue', Helvetica, Arial, sans-serif";
                ctx.fillText(enrollValue, enrollX + 90, rowY);

                // Births change - Subdued but clear
                const birthsX = enrollX + 200;
                ctx.fillStyle = '#7a7a7a';
                ctx.font = "500 12px 'Helvetica Neue', Helvetica, Arial, sans-serif";
                ctx.fillText('Births', birthsX, rowY);
                
                // Births value - Muted color
                const birthsValue = row.births;
                ctx.fillStyle = birthsValue.startsWith('-') ? '#9b4444' : birthsValue.startsWith('+') ? '#4a7c59' : '#7a7a7a';
                ctx.font = row.isPrimary ? 
                    "600 16px 'Helvetica Neue', Helvetica, Arial, sans-serif" : 
                    "500 14px 'Helvetica Neue', Helvetica, Arial, sans-serif";
                ctx.fillText(birthsValue, birthsX + 60, rowY);

                // Time period - Small, supporting detail
                ctx.fillStyle = '#9a9a9a';
                ctx.font = "400 11px 'Helvetica Neue', Helvetica, Arial, sans-serif";
                ctx.fillText(row.period, padding + 20, rowY + 18);

                // Subtle separator between rows
                if (index < statRows.length - 1) {
                    ctx.strokeStyle = '#e8e8e8';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(padding + 20, rowY + 28);
                    ctx.lineTo(width - padding - 20, rowY + 28);
                    ctx.stroke();
                }

                rowY += rowHeight;
            });

            // ============ FOOTER SECTION - Professional Branding ============
            const footerTop = statsTop + statsHeight + 20;
            
            // Footer divider
            ctx.strokeStyle = '#d0d0d0';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, footerTop);
            ctx.lineTo(width - padding, footerTop);
            ctx.stroke();

            let footerLogoImage = null;
            try {
                footerLogoImage = await loadImageFromDataUri(LOGO_DATA_URI);
            } catch (error) {
                console.warn('Export logo failed to load; continuing without logo.', error);
            }

            const logoMaxHeight = 32;
            const logoTextPadding = 12;
            let footerTextX = padding;

            if (footerLogoImage && footerLogoImage.naturalWidth > 0 && footerLogoImage.naturalHeight > 0) {
                const logoScale = Math.min(logoMaxHeight / footerLogoImage.naturalHeight, 1);
                const logoWidth = footerLogoImage.naturalWidth * logoScale;
                const logoHeight = footerLogoImage.naturalHeight * logoScale;
                const logoY = footerTop + 12;
                ctx.drawImage(footerLogoImage, padding, logoY, logoWidth, logoHeight);
                footerTextX = padding + logoWidth + logoTextPadding;
            }

            // Branding - Professional, not intrusive
            ctx.fillStyle = '#5a5a5a';
            ctx.font = "500 13px 'Helvetica Neue', Helvetica, Arial, sans-serif";
            ctx.fillText('Prepared by Planfully Consulting', footerTextX, footerTop + 25);
            
            // Website - Lighter
            ctx.fillStyle = '#8a8a8a';
            ctx.font = "400 12px 'Helvetica Neue', Helvetica, Arial, sans-serif";
            ctx.fillText('planfullyconsulting.com', footerTextX, footerTop + 45);

            // Data sources - Right-aligned, professional
            let dataSource = 'Data: NCES Common Core of Data, CDC Natality Files';
            const reportDate = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            ctx.font = "500 13px 'Helvetica Neue', Helvetica, Arial, sans-serif";
            const preparedByWidth = ctx.measureText('Prepared by Planfully Consulting').width;
            ctx.font = "400 12px 'Helvetica Neue', Helvetica, Arial, sans-serif";
            const websiteWidth = ctx.measureText('planfullyconsulting.com').width;
            const leftBlockRight = footerTextX + Math.max(preparedByWidth, websiteWidth);

            ctx.font = "400 11px 'Helvetica Neue', Helvetica, Arial, sans-serif";
            const fullDataSourceWidth = ctx.measureText(dataSource).width;
            const rightBlockLeft = width - padding - fullDataSourceWidth;
            if (leftBlockRight + 24 > rightBlockLeft) {
                dataSource = 'Data: NCES CCD, CDC Natality Files';
            }

            ctx.fillStyle = '#7a7a7a';
            ctx.font = "400 11px 'Helvetica Neue', Helvetica, Arial, sans-serif";
            ctx.textAlign = 'right';
            ctx.fillText(dataSource, width - padding, footerTop + 25);
            ctx.fillText(reportDate, width - padding, footerTop + 45);
            ctx.textAlign = 'left'; // Reset

            // Generate filename with district name
            const sanitizedName = districtName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const filename = `enrollment_trends_${sanitizedName}.png`;

            const link = document.createElement('a');
            link.download = filename;
            link.href = combined.toDataURL('image/png');
            link.click();
        }
        
        // Accordion
        function toggleAccordion() {
            if (!dom.accordionContent || !dom.accordionArrow) {
                return;
            }
            dom.accordionContent.classList.toggle('show');
            dom.accordionArrow.classList.toggle('open');
        }
        
        function init() {
            dom.searchInput = getEl('districtSearch');
            dom.dropdown = getEl('autocompleteDropdown');
            dom.loadingIndicator = getEl('loadingIndicator');
            dom.contentWrapper = getEl('contentWrapper');
            dom.chartSubtitle = getEl('chartSubtitle');
            dom.statsHeader = getEl('statsHeader');
            dom.districtBtn = getEl('districtBtn');
            dom.exportButton = getEl('exportButton');
            dom.exportLogo = getEl('exportLogo');
            dom.chartWrapper = getEl('chartWrapper');
            dom.birthsPanel = getEl('birthsPanel');
            dom.birthsCanvas = getEl('birthsChart');
            dom.birthsUnavailable = getEl('birthsUnavailable');
            dom.accordionHeader = getEl('accordionHeader');
            dom.accordionContent = getEl('accordionContent');
            dom.accordionArrow = getEl('accordionArrow');
            dom.statPeriods = Array.from(document.querySelectorAll('.stat-period'));
            
            if (dom.searchInput) {
                dom.searchInput.addEventListener('input', handleSearchInput);
            }
            document.addEventListener('click', handleDocumentClick);
            
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.addEventListener('click', () => setTimeRange(btn.dataset.range || 'all', btn));
            });
            
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => toggleView(btn.dataset.view || 'district', btn));
            });
            
            if (dom.exportLogo) {
                dom.exportLogo.src = LOGO_SRC;
            }

            if (dom.exportButton) {
                dom.exportButton.addEventListener('click', exportToPNG);
            }
            
            if (dom.accordionHeader) {
                dom.accordionHeader.addEventListener('click', toggleAccordion);
            }
            
            loadData();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', init);
        
    </script>
</body>
</html>
